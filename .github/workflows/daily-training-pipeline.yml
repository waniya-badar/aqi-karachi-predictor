name: Daily Model Training Pipeline (Cloud Storage)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  model-training:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify MongoDB connection
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from src.mongodb_handler import MongoDBHandler
          
          print('Connecting to MongoDB Cloud...')
          db = MongoDBHandler()
          
          # Check data availability
          total_records = db.db.features.count_documents({})
          print(f'Total feature records: {total_records}')
          
          if total_records < 100:
              print(f'ERROR: Insufficient data ({total_records} < 100)')
              sys.exit(1)
          
          # Check existing models
          models = db.get_all_models_metadata()
          print(f'Existing models in MongoDB: {len(models)}')
          for m in models:
              model_name = m.get('model_name', 'Unknown')
              r2_score = m.get('metrics', {}).get('test_r2', 'N/A')
              print(f'  - {model_name}: R²={r2_score}')
          
          # Check archived models
          archives = db.get_all_archived_models(limit=5)
          print(f'Archived model versions: {len(archives)}')
          
          db.close()
          print('MongoDB connection verified!')
          "
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
      
      - name: Run model training (Cloud Storage - Versioned)
        run: |
          python pipelines/training_pipeline.py
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
      
      - name: Verify models saved to MongoDB Cloud
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from src.mongodb_handler import MongoDBHandler
          
          print('Verifying models in MongoDB Cloud...')
          db = MongoDBHandler()
          
          # Get all models
          models = db.get_all_models_metadata()
          
          if not models or len(models) < 3:
              print(f'ERROR: Expected 3 models, found {len(models)}')
              sys.exit(1)
          
          print(f'All {len(models)} models saved to MongoDB Cloud:')
          print(f'   Collection: models (latest versions)')
          for m in models:
              model_name = m.get('model_name', 'Unknown')
              metrics = m.get('metrics', {})
              is_best = ' (BEST)' if m.get('is_best') else ''
              print(f'  - {model_name}: R²={metrics.get("test_r2", 0):.4f}, RMSE={metrics.get("test_rmse", 0):.2f}{is_best}')
          
          # Check archived versions
          archives = db.get_all_archived_models(limit=10)
          print(f'\nArchived versions: {len(archives)} (all versions preserved)')
          
          # Get best model
          best = db.get_best_model()
          if best:
              print(f'\nBest Model: {best["model_name"]}')
              print(f'   Test R²: {best.get(\"metrics\", {}).get(\"test_r2\", 0):.4f}')
          
          # Get training history
          history = db.get_training_history(limit=3)
          print(f'\nRecent Training History: {len(history)} runs')
          for h in history:
              print(f'  - {h.get(\"timestamp\", \"Unknown\")}')
          
          db.close()
          print(f'\nVERIFICATION COMPLETE')
          print(f'   All models are safely stored in MongoDB Cloud with versioning.')
          "
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
      
      - name: Create job summary
        if: always()
        run: |
          echo "## Daily Model Training Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Storage** | MongoDB Cloud |" >> $GITHUB_STEP_SUMMARY
          echo "| **Models Trained** | Ridge, Gradient Boosting, Random Forest |" >> $GITHUB_STEP_SUMMARY
          echo "| **Data Window** | Last 120 days |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Serverless Architecture" >> $GITHUB_STEP_SUMMARY
          echo "- Models stored directly in MongoDB (no local files)" >> $GITHUB_STEP_SUMMARY
          echo "- Streamlit app loads models from MongoDB on demand" >> $GITHUB_STEP_SUMMARY
          echo "- Fully automated, no manual intervention needed" >> $GITHUB_STEP_SUMMARY
