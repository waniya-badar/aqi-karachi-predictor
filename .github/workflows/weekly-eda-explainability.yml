name: Weekly EDA & Explainability Analysis

on:
  schedule:
    # Run every Sunday at 1 AM UTC
    - cron: '0 1 * * 0'
  workflow_dispatch:

jobs:
  eda-explainability:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install jupyter nbconvert
      
      - name: Set environment variables
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
        run: |
          echo "MONGODB_URI=$MONGODB_URI" >> $GITHUB_ENV
          echo "MONGODB_DB_NAME=$MONGODB_DB_NAME" >> $GITHUB_ENV
      
      - name: Download trained models from latest training run
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: daily-training-pipeline.yml
          name: trained-models
          path: models/saved_models/
          if_no_artifact_found: warn
      
      - name: List downloaded models
        run: |
          echo "Models directory contents:"
          ls -la models/saved_models/ || echo "No models directory"
      
      - name: Run EDA analysis
        run: |
          python notebooks/eda_analysis.py
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
      
      - name: Run SHAP & LIME explainability
        run: |
          python notebooks/explainability_analysis.py
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
      
      - name: Execute Jupyter notebook
        run: |
          jupyter nbconvert --to notebook --execute notebooks/eda_and_explainability.ipynb --output=eda_and_explainability_output.ipynb
      
      - name: Archive analysis results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eda-explainability-results
          path: |
            notebooks/plots/
            eda_and_explainability_output.ipynb
          retention-days: 90
      
      - name: Create analysis summary
        if: always()
        run: |
          echo "## Weekly EDA & Explainability Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Outputs**: EDA plots, SHAP analysis, LIME explanations" >> $GITHUB_STEP_SUMMARY
