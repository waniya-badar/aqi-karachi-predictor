name: Hourly Feature Engineering Pipeline

on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  feature-engineering:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Set environment variables
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
          AQICN_API_KEY: ${{ secrets.AQICN_API_KEY }}
        run: |
          echo "MONGODB_URI=$MONGODB_URI" >> $GITHUB_ENV
          echo "MONGODB_DB_NAME=$MONGODB_DB_NAME" >> $GITHUB_ENV
          echo "AQICN_API_KEY=$AQICN_API_KEY" >> $GITHUB_ENV
      
      - name: Run feature engineering pipeline
        run: |
          python pipelines/feature_pipeline.py
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
          AQICN_API_KEY: ${{ secrets.AQICN_API_KEY }}
      
      - name: Verify features in database
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from src.mongodb_handler import MongoDBHandler
          
          db = MongoDBHandler()
          count = db.db.features.count_documents({})
          print(f'Total records: {count}')
          
          if count > 0:
              print('Feature engineering successful')
              sys.exit(0)
          else:
              print('No records found')
              sys.exit(1)
          "
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
      
      - name: Create summary
        if: always()
        run: |
          echo "## Feature Engineering Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const body = 'Feature engineering pipeline failed! Check the logs.';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Wrap in try/catch to avoid unhandled errors in the notification step
            try {
              const issueNumber = context.issue && context.issue.number ? Number(context.issue.number) : null;

              if (issueNumber && !Number.isNaN(issueNumber) && issueNumber > 0) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body
                });
              } else {
                // Create a new issue so maintainers are notified and include run link
                const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${github.context.runId}`;
                await github.rest.issues.create({
                  owner,
                  repo,
                  title: 'CI: Feature engineering pipeline failed',
                  body: `${body}\n\nRun details: ${runUrl}`
                });
              }
            } catch (err) {
              console.log('Notification step failed:', err && err.message ? err.message : err);
              // Don't rethrow: notification failure should not mask original job logs
            }
